<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ASV_analysis — asv_analysis • EvoTraceR</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="ASV_analysis — asv_analysis"><meta property="og:description" content="This function performs the analysis on ASV sequences identified by the previous steps and aligns them to the reference sequence.
First, it pools together those sequences characterized by a Hamming distance equals or lower than 2, summing their counts. To perform this step, EvoTraceR uses the
sequence clusering agorithm impemented in the python package UMI-tools
Then it performs pairwise alignment using Needleman-Wunsch global alignment algorithm implemented in function pairwiseAlignment
in package Biostrings, aligning each sequence to the original barcode considered in the analysis.
(See the Biostrings documentation here for more details).
After identifying all indels (insertions are identified by their start position and number of nucleoides inserted, while deletions are identified by their start and end position),
it removes the ones that are too small and don't span any cut site: to perform this filter, it exapnds the start and end position by the number of bases specified in the parameter cleaning_window,
it counts the number of cut sites spanned after the expantion and it removes those that span 0 sites.
Next, it pools together those sequences that differ by one another only by substitutions, summing their counts, and then it removes
those sequences showing a frequency lower than the threshold specified in parameter asv_count_cutoff.
Next, it performs filtering of the sequences based on their flanking sequences and finally it computes the normalized counts of each ASV in each sample,
dividing each count by the total number of sequences for each sample and multiplying by 1e6, yelding Counts Per Million (CPM)."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EvoTraceR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/1_introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/2_running_REvoBC.html">Running EvoTraceR</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/Nowak-Lab/EvoTraceR/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>ASV_analysis</h1>
    <small class="dont-index">Source: <a href="https://github.com/Nowak-Lab/EvoTraceR/blob/HEAD/R/user_functions.R" class="external-link"><code>R/user_functions.R</code></a></small>
    <div class="hidden name"><code>asv_analysis.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function performs the analysis on ASV sequences identified by the previous steps and aligns them to the reference sequence.
First, it pools together those sequences characterized by a Hamming distance equals or lower than 2, summing their counts. To perform this step, EvoTraceR uses the
sequence clusering agorithm impemented in the python package <a href="https://umi-tools.readthedocs.io/en/latest/QUICK_START.html" class="external-link">UMI-tools</a>
Then it performs pairwise alignment using Needleman-Wunsch global alignment algorithm implemented in function <code>pairwiseAlignment</code>
in package <code>Biostrings</code>, aligning each sequence to the original barcode considered in the analysis.
(See the Biostrings documentation <a href="https://www.rdocumentation.org/packages/Biostrings/versions/2.40.2/topics/pairwiseAlignment" class="external-link">here</a> for more details).
After identifying all indels (insertions are identified by their start position and number of nucleoides inserted, while deletions are identified by their start and end position),
it removes the ones that are too small and don't span any cut site: to perform this filter, it exapnds the start and end position by the number of bases specified in the parameter <code>cleaning_window</code>,
it counts the number of cut sites spanned after the expantion and it removes those that span 0 sites.
Next, it pools together those sequences that differ by one another only by substitutions, summing their counts, and then it removes
those sequences showing a frequency lower than the threshold specified in parameter <code>asv_count_cutoff</code>.
Next, it performs filtering of the sequences based on their flanking sequences and finally it computes the normalized counts of each ASV in each sample,
dividing each count by the total number of sequences for each sample and multiplying by 1e6, yelding Counts Per Million (CPM).</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">asv_analysis</span><span class="op">(</span></span>
<span>  <span class="va">EvoTraceR_object</span>,</span>
<span>  ref_name <span class="op">=</span> <span class="st">"BC10v0"</span>,</span>
<span>  ref_seq <span class="op">=</span></span>
<span>    <span class="st">"TCTACACGCGCGTTCAACCGAGGAAAACTACACACACGTTCAACCACGGTTTTTTACACACGCATTCAACCACGGACTGCTACACACGCACTCAACCGTGGATATTTACATACTCGTTCAACCGTGGATTGTTACACCCGCGTTCAACCAGGGTCAGATACACCCACGTTCAACCGTGGTACTATACTCGGGCATTCAACCGCGGCTTTCTGCACACGCCTACAACCGCGGAACTATACACGTGCATTCACCCGTGGATC"</span>,</span>
<span>  ref_flank_left <span class="op">=</span> <span class="st">"^TCTAC"</span>,</span>
<span>  ref_flank_right <span class="op">=</span> <span class="st">"CCCGTGGATC$"</span>,</span>
<span>  flanking_filtering <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>  ref_cut_sites <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">17</span>, <span class="fl">43</span>, <span class="fl">69</span>, <span class="fl">95</span>, <span class="fl">121</span>, <span class="fl">147</span>, <span class="fl">173</span>, <span class="fl">199</span>, <span class="fl">225</span>, <span class="fl">251</span><span class="op">)</span>,</span>
<span>  ref_border_sites <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">26</span>, <span class="fl">52</span>, <span class="fl">78</span>, <span class="fl">104</span>, <span class="fl">130</span>, <span class="fl">156</span>, <span class="fl">182</span>, <span class="fl">208</span>, <span class="fl">234</span><span class="op">)</span>,</span>
<span>  output_figures <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  asv_count_cutoff <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  pwa_gapOpening <span class="op">=</span> <span class="op">-</span><span class="fl">25</span>,</span>
<span>  pwa_gapExtension <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  pwa_match <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  pwa_mismatch <span class="op">=</span> <span class="op">-</span><span class="fl">4</span>,</span>
<span>  pwa_type <span class="op">=</span> <span class="st">"global"</span>,</span>
<span>  cleaning_window <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  cores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>EvoTraceR_object</dt>
<dd><p>(Required). Object of class EvoTraceR, result of the function <code>initialize_EvoTraceR</code></p></dd>


<dt>ref_name</dt>
<dd><p>String indicating the ID of the reference sequence used in the experiment. Default is 'BC10v0',</p></dd>


<dt>ref_seq</dt>
<dd><p>String indicating the reference sequence used in the experimenti. Default is 'TCTACACGCGCGTTCAACCGAGGAAAACTACACACACGTTCAACCACGGTTTTTTACACACGCATTCAACCACGGACTGCTACACACGCACTCAACCGTGGATATTTACATACTCGTTCAACCGTGGATTGTTACACCCGCGTTCAACCAGGGTCAGATACACCCACGTTCAACCGTGGTACTATACTCGGGCATTCAACCGCGGCTTTCTGCACACGCCTACAACCGCGGAACTATACACGTGCATTCACCCGTGGATC',</p></dd>


<dt>ref_flank_left</dt>
<dd><p>String indicating the first nucleotides of the reference sequence that never mutate over the
course of the experiment. Default is "^TCTAC",</p></dd>


<dt>ref_flank_right</dt>
<dd><p>String indicating the first nucleotides of the reference sequence that never mutate over the
course of the experiment. Default is "CCCGTGGATC$",</p></dd>


<dt>flanking_filtering</dt>
<dd><p>Which among the flaning regions to use to filter out contaminated sequences.
Must be one of c('left', 'right', 'both', 'either'), default is 'both'</p></dd>


<dt>ref_cut_sites</dt>
<dd><p>Positions in the reference sequence of the cutting sites. Default is c(17, 42, 68, 94, 120, 146, 171, 198, 224, 251),</p></dd>


<dt>ref_border_sites</dt>
<dd><p>c(26, 52, 78, 104, 130, 156, 182, 208, 234).</p></dd>


<dt>output_figures</dt>
<dd><p>(Optional). Default TRUE: Boolean indicating whether a user whishes to store a figure indicating the number of ASV tracked during the different steps of the analysis.</p></dd>


<dt>asv_count_cutoff</dt>
<dd><p>(Optional). Default to 2. Minimum number of counts for an ASV to be considered in the statistics.</p></dd>


<dt>pwa_gapOpening</dt>
<dd><p>(Optional). Default is -25. Parameter <code>gapOpening</code> passed to <code>pairwiseAlignment</code> from <code>Biostrings</code> (See description).</p></dd>


<dt>pwa_gapExtension</dt>
<dd><p>(Optional). Default is 0. Parameter <code>gapExtension</code> passed to <code>pairwiseAlignment</code> from <code>Biostrings</code> (See description). Default is 0.</p></dd>


<dt>pwa_match</dt>
<dd><p>(Optional). Default is 15. Parameter indicating the score for matches during pairwise alignment with <code>Biostrings</code>. This parameter,
together with the previous one, are used to construct the substitution matrix used by the function <code>pairwiseAlignment</code>.</p></dd>


<dt>pwa_mismatch</dt>
<dd><p>(Optional). Default is -4. Parameter indicating the penalty for mismatch events during pairwise alignment with <code>Biostrings</code>.</p></dd>


<dt>pwa_type</dt>
<dd><p>(Optional). Parameter indicating the type of pairwise alignment. Must be one of One of "global", "local", "overlap", "global-local", and "local-global".
For more details see <a href="https://www.rdocumentation.org/packages/Biostrings/versions/2.40.2/topics/pairwiseAlignment" class="external-link">original documentation</a></p></dd>


<dt>cleaning_window</dt>
<dd><p>(Optional). Default is c(3,3). Vector containing the number of nucleotides that we use for extending respectively the start and end position of each indel to determine the ones that don't span any cut sites and thus get removed. (See description for more information).</p></dd>


<dt>batch_size</dt>
<dd><p>(Optional). Default is 100. Number of batches to split reads into for parallel execution of <code>pairwiseAlignment</code>. This parameter can be tuned together with the cores parameter to optimize the speed of alignment.</p></dd>


<dt>cores</dt>
<dd><p>(Optional). Default is parallel::detectCores(). Number of cores to use for pairwise alignment.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>The EvoTraceR object passed as a parameter with the following new fields:</p><ul><li><p><code>clean_asv_dataframe</code>: ASV sequences identified post-filtering (contamination removed,
sequences with a similarity higher than <code>pid_cutoff_nmbc</code> to the original barcode
aggregated to it and ASVs named in increasing order (ASV01, ASV02, etc.) according
to their total counts.</p></li>
<li><p><code>reference</code>: Info about the reference sequence used for the current analysis.</p></li>
<li><p><code>statistics</code>: another list with the following sub-fields:</p><ul><li><p><code>asv_df_percentages</code>: dataframe with six columns. <code>asv_names</code> is the name of the ASV.
<code>sample</code> is the sample identifier (e.g. ID of an organ or, in case of longitudinal data, of the timepoint);
<code>count</code>: total counts per million for a specific ASV in a specific sample;
<code>perc_in_sample</code>: CPM normalized to the total counts in the corresponding sample;
<code>perc_asv</code>: CPM normalized to the total counts for the corresponding ASV;
<code>perc_fold_to_max</code>: CPM normalized to the maximum counts observed for the corresponding ASV in a sample.</p></li>
<li><p><code>asv_totalCounts</code>: for each ASV, total counts and number of samples in which it was detected.</p></li>
<li><p><code>sample_totalcounts</code>: for each sample, total counts and number of distinct ASVs detected.</p></li>
<li><p><code>asv_diversity_persample</code>: measures of clonal richness and measures of heterogeneity computed for each sample based on the ASVs detected.</p></li>
<li><p><code>asv_persample_frequency</code>: counts for each ASV in each sample.</p></li>
<li><p><code>asv_persample_detection</code>: binary matrix indicating whether a sequence has been detected in the corresponding sample.</p></li>
<li><p><code>asv_toBarcode_similarity</code>: edit distance, percentage similarity and alignment score of each ASV compared to the original barcode.</p></li>
<li><p><code>all_asv_statistics</code>: all the statistics computed on each ASV grouped together in the same tibble.</p></li>
</ul></li>
<li><p><code>alignment</code>, another list with the following fields:</p><ul><li><p><code>Binary_mutation_matrix</code>: binary matrix encoding the presence/absence of a mutation in an ASV.</p></li>
<li><p><code>asv_barcode_alignment</code>: tibble where each line corresponds to a position in a ASV, and the columns encode the following information:</p><ul><li><p>asv_names: name of the ASV</p></li>
<li><p>sample: sample identifier</p></li>
<li><p>position_bc260: position of the alteration in the original barcode. Note that insertions
are assigned to the position that coincides with their beginning.</p></li>
<li><p>alt: type of alteration. wt = Wild Type (i.e. non-mutated position). sub = substitution. del = deletion. ins = insertion.</p></li>
<li><p>ref_asv,</p></li>
<li><p>read_asv: respectively, the reference nucleotide observed in the original barcode and the one observed on the sequence.</p></li>
</ul></li>
<li><p><code>mutations_coordinates</code>: dataframe containing a list of all mutations, with their start and end position.</p></li>
<li><p><code>ASV_alterations_width</code>: dataframe containing the number of nucleotides affected by each type of mutation in each ASV.</p></li>
</ul></li>
</ul><p>This function saves the figure <code>asv_filtering_freq.pdf</code>, which is a barplot indicating the change in the number of sequences 
during all the processing steps.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>Then, using the CPM it computes different statistics for the final ASVS, storing:
 the relative frequency of all ASVs in each sample. 
 the relative frequency of each ASV in the samples.
 the counts for each ASV normalized to the counts of the sample with maximum frequency.
 the frequency of the different ASVs in each sample.</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">EvoTraceR_object</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">EvoTraceR_object</span> <span class="op">=</span> <span class="fu">asv_analysis</span><span class="op">(</span>EvoTraceR_object <span class="op">=</span> <span class="va">EvoTraceR_object</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Lucrezia Patruno, Daniele Ramazzotti, Armin Scheben, Stephen Staklinski, Rebecca Hassett, Dawid Nowak.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

      </footer></div>

  


  

  </body></html>

